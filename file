# upload.py
import requests
import os
import json

UPLOADTHING_APP_ID = 'clipboard'
UPLOADTHING_SECRET = 'eyJhcGlLZXkiOiJza19saXZlX2IzMDI1MWNhMGU5ZWIxYWMyOGY0MmI4YTliYzI4ZmMxNzg5YzRjNTY0ZjFkNWFkNmRiZjZjNGI3YzZhNzQ4NmUiLCJhcHBJZCI6InIxNnI0dGY0NnEiLCJyZWdpb25zIjpbInNlYTEiXX0='
UPSTASH_REDIS_REST_URL = "https://apparent-buzzard-47270.upstash.io"
UPSTASH_REDIS_REST_TOKEN = "AbimAAIjcDFkMTZmMGE2YWU5M2E0ODgzODJhNjE3NWY1NGQ5MmFkZnAxMA"

def upload_file(file_path):
    file_name = os.path.basename(file_path)
    print(f"Uploading {file_name}...")
    
    # Step 1: Get Upload URL from UploadThing
    headers = {"Authorization": f"Bearer {UPLOADTHING_SECRET}"}
    payload = {
        "files": [
            {
                "name": file_name,
                "size": os.path.getsize(file_path),
                "type": "application/zip"
            }
        ]
    }
    res = requests.post(f"https://uploadthing.com/api/uploadFiles", json=payload, headers=headers)
    res.raise_for_status()
    upload_url = res.json()["data"]["urls"][0]["url"]
    upload_res = requests.put(upload_url, data=open(file_path, "rb"))
    upload_res.raise_for_status()

    # Public URL
    file_key = res.json()["data"]["urls"][0]["key"]
    public_url = f"https://utfs.io/f/{file_key}"
    print("Uploaded to:", public_url)

    # Step 2: Store URL in Redis
    redis_res = requests.post(
        f"{UPSTASH_REDIS_REST_URL}/set",
        headers={"Authorization": f"Bearer {UPSTASH_REDIS_REST_TOKEN}"},
        params={"_key": "latest_zip_url", "_value": public_url}
    )
    print("Stored URL in Redis:", redis_res.text)

if __name__ == "__main__":
    zip_path = input("Enter full path to .zip file: ")
    upload_file(zip_path)
